name: Update Prompt Library

on:
  schedule:
    - cron: '0 0 * * 1' # æ¯å‘¨ä¸€å›½é™…æ ‡å‡†æ—¶é—´ 0ç‚¹ è¿è¡Œ
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'build/**'      # å½“ build ç›®å½•æœ‰è„šæœ¬ä¿®æ”¹æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. æ‹‰å– tldr å®˜æ–¹æ•°æ®
      - name: Checkout Official Tldr Data
        uses: actions/checkout@v4
        with:
          repository: tldr-pages/tldr
          path: build/tldr
          sparse-checkout: |
            pages
            pages.zh
          fetch-depth: 1

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 4. å®‰è£…ä¾èµ– (Prompt è„šæœ¬éœ€è¦ requests)
      - name: Install Dependencies
        run: pip install requests

      # 5. è¿è¡Œ TLDR æ„å»ºè„šæœ¬ (ç”Ÿæˆ commands-*.json å’Œ manifest_tldr_partial.json)
      - name: Build Commands (Tldr)
        run: python build/build_tldr.py

      # 6. è¿è¡Œ Prompt æ„å»ºè„šæœ¬ (ç”Ÿæˆ prompts-*.json å’Œ manifest_prompts_partial.json)
      - name: Build Prompts (Roles)
        run: python build/build_prompts.py

      # 7. âœ¨ æ ¸å¿ƒæ­¥éª¤ï¼šåˆå¹¶æ¸…å• (Merge Manifests)
      # è¿™æ®µ Python è„šæœ¬ä¼šæ‰«ææ‰€æœ‰ *_partial.json å¹¶åˆå¹¶ä¸ºæœ€ç»ˆçš„ manifest.json
      - name: Merge Manifests
        run: |
          python -c "
          import json
          import os
          import time

          dist_dir = 'build/dist'
          all_packages = []
          
          print('ğŸ”„ Merging manifests...')

          # æ‰«ææ‰€æœ‰ä»¥ _partial.json ç»“å°¾çš„æ–‡ä»¶
          if os.path.exists(dist_dir):
              for f in os.listdir(dist_dir):
                  if f.endswith('_partial.json'):
                      path = os.path.join(dist_dir, f)
                      try:
                          with open(path, 'r', encoding='utf-8') as fp:
                              data = json.load(fp)
                              if isinstance(data, list):
                                  all_packages.extend(data)
                                  print(f'  â• Added {len(data)} packs from {f}')
                              else:
                                  print(f'  âš ï¸ Warning: {f} is not a list, skipping.')
                          
                          # åˆå¹¶ååˆ é™¤ç‰‡æ®µæ–‡ä»¶ï¼Œä¿æŒæ•´æ´
                          os.remove(path) 
                      except Exception as e:
                          print(f'  âŒ Error reading {f}: {e}')

          # æ„å»ºæœ€ç»ˆæ¸…å•å¯¹è±¡
          final_manifest = {
              'updated_at': int(time.time() * 1000),
              'version': '2.0.0', # å‡çº§ç‰ˆæœ¬å·
              'packages': all_packages
          }

          # å†™å…¥æœ€ç»ˆæ–‡ä»¶
          with open(os.path.join(dist_dir, 'manifest.json'), 'w', encoding='utf-8') as f:
              json.dump(final_manifest, f, indent=2, ensure_ascii=False)
          
          print(f'âœ… Final manifest.json created with {len(all_packages)} total packages.')
          "

      # 8. æäº¤ç»“æœåˆ° GitHub
      - name: Commit and Push to GitHub
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # å¼ºåˆ¶æ·»åŠ  dist ç›®å½• (å³ä½¿è¢« gitignore)
          git add -f build/dist
          
          if git diff --staged --quiet; then
            echo "âœ… GitHub: æ•°æ®æ²¡æœ‰å˜åŒ–ã€‚"
          else
            git commit -m "chore(data): auto-update prompts library [skip ci]"
            git push origin main
            echo "ğŸš€ GitHub: æ•°æ®å·²æ›´æ–°ï¼"
          fi

      # 9. åŒæ­¥åˆ° Gitee (ä¿æŒåŸæ ·ï¼Œçº¯å‡€åŒæ­¥ build å’Œ models)
      - name: Sync Only build & models to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          if [ -z "$GITEE_TOKEN" ]; then
            echo "âŒ Error: GITEE_TOKEN is not set."
            exit 1
          fi

          echo "ğŸ“¥ Cloning Gitee repo..."
          git clone https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git gitee_workspace

          echo "ğŸ§¹ Cleaning Gitee workspace..."
          cd gitee_workspace
          git rm -rf . --ignore-unmatch
          git clean -fdx
          cd ..

          echo "Dg Copying specific folders..."
          mkdir -p gitee_workspace/build
          cp -r build/* gitee_workspace/build/
          
          mkdir -p gitee_workspace/models
          cp -r models/* gitee_workspace/models/
          
          cd gitee_workspace
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Gitee: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ¨é€ã€‚"
          else
            echo "ğŸ“¦ Pushing clean state to Gitee..."
            git commit -m "chore(sync): sync build and models only [skip ci]"
            git push https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git master
            echo "ğŸš€ Gitee: åŒæ­¥æˆåŠŸï¼"
          fi